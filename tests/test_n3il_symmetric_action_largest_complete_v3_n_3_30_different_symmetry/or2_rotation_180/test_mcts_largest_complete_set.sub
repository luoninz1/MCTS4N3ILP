#!/bin/bash

#SBATCH --job-name=placeholder     ## job name
#SBATCH -A NCKAPLAN_LAB     ## Class account to charge resources
#SBATCH -p standard                ## partition name
#SBATCH --nodes=1             ## (-N) number of nodes the job will use
#SBATCH --ntasks=1            ## (-n) number of processes to be launched
#SBATCH -c 1                 ## number of cores
#SBATCH --mem=6G           ## placeholder memory for dynamic allocation
#SBATCH --time 14-00:00:00     ## time limit (14 days)
#SBATCH --error=logs/slurm-%J.err  ## error log file
#SBATCH --output=logs/slurm-%J.out ## output log file
#SBATCH --mail-type=fail,end
#SBATCH --mail-user=luoninz1@uci.edu

module load miniconda3/24.9.2
source /opt/apps/miniconda3/24.9.2/etc/profile.d/conda.sh
conda activate mcgs-env

export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
export MKL_NUM_THREADS=$SLURM_CPUS_PER_TASK
export OPENBLAS_NUM_THREADS=$SLURM_CPUS_PER_TASK
export NUMBA_NUM_THREADS=$SLURM_CPUS_PER_TASK
export NUMBA_THREADING_LAYER=omp

# ===== Expected resources (derived from start) vs Actual resources (after sbatch override) =====
# Fixed resources: 1 core / 6G
start="$1"

# Determine symmetric_action from parent folder name
# e.g., if folder is "or2_rotation_180", this extracts "rotation_180"
current_dir=$(basename "$PWD")
symmetric_action=$(echo "$current_dir" | sed 's/^or[0-9]*_//')

# Dynamically update job name, include start and symmetric_action for identification
scontrol update JobId=$SLURM_JOB_ID JobName="n${start}_${symmetric_action}_mcts_largest_complete_test" >/dev/null 2>&1 || true

echo "========== RESOURCE CHECK (JobID=$SLURM_JOB_ID) =========="
echo "Start parameter        : ${start}"
echo "Fixed Resources        : CPUs=1, MEM=6G"
echo "SLURM_CPUS_PER_TASK    : ${SLURM_CPUS_PER_TASK:-N/A}"
echo "SLURM_JOB_CPUS_PER_NODE: ${SLURM_JOB_CPUS_PER_NODE:-N/A}"
echo "SLURM_MEM_PER_CPU      : ${SLURM_MEM_PER_CPU:-N/A}  (MB, if defined by site)"
echo "SLURM_MEM_PER_NODE     : ${SLURM_MEM_PER_NODE:-N/A} (MB, if defined by site)"
echo "--- scontrol show job (key fields) ---"
scontrol show job $SLURM_JOB_ID | awk '
/JobName=|Partition=|Ntasks=|NumCPUs=|TRES=|MinMemory/{
  gsub(/\r/,""); print
}'
echo "=========================================================="

echo "Detected folder: ${current_dir} -> Using symmetric_action: ${symmetric_action}"

# $1 = start value, $2 = step size
python symmetric_action_largest_complete_v3.py \
    --start "$1" \
    --end 31 \
    --step 5 \
    --repeat 10 \
    --symmetric_action "${symmetric_action}" \
    > logs/test_n3il_symmetric_action_largest_complete_v3_different_symmetry_${symmetric_action}_n_"$1".log