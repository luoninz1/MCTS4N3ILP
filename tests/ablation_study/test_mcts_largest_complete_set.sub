#!/bin/bash

#SBATCH --job-name=placeholder     ## job name
#SBATCH -A NCKAPLAN_LAB     ## Class account to charge resources
#SBATCH -p standard                ## partition name
#SBATCH --nodes=1             ## (-N) number of nodes the job will use
#SBATCH --ntasks=1            ## (-n) number of processes to be launched
#SBATCH -c 1                 ## number of cores
#SBATCH --mem=6G           ## placeholder memory for dynamic allocation
#SBATCH --time 14-00:00:00     ## time limit (14 days)
#SBATCH --error=logs/slurm-%J.err  ## error log file
#SBATCH --output=logs/slurm-%J.out ## output log file
#SBATCH --mail-type=fail,end
#SBATCH --mail-user=luoninz1@uci.edu

module load miniconda3/24.9.2
source /opt/apps/miniconda3/24.9.2/etc/profile.d/conda.sh
conda activate mcgs-env

export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
export MKL_NUM_THREADS=$SLURM_CPUS_PER_TASK
export OPENBLAS_NUM_THREADS=$SLURM_CPUS_PER_TASK
export NUMBA_NUM_THREADS=$SLURM_CPUS_PER_TASK
export NUMBA_THREADING_LAYER=omp

# Arguments received from submit_all.sh
n="$1"
seed="$2"
variant="$3"
env="$4"
sym_action="$5"
max_sym_level="$6"
save_opt="$7"
comment="$8"
algo="$9"

# Update job name for easier monitoring: Variant_nGrid_tSeed
# e.g., M0_n30_t5
scontrol update JobId=$SLURM_JOB_ID JobName="${variant}_n${n}_t${seed}" >/dev/null 2>&1 || true

echo "========== CONFIGURATION =========="
echo "Grid Size (n)    : ${n}"
echo "Seed (Trial)     : ${seed}"
echo "Variant          : ${variant}"
echo "Environment      : ${env}"
echo "Symmetric Action : ${sym_action}"
echo "Max Sym Level    : ${max_sym_level}"
echo "Save Optimal     : ${save_opt}"
echo "Algorithm        : ${algo}"
echo "Comment          : ${comment}"
echo "==================================="

# Build the python command
# Note: repeat=1 because the loop in shell script handles the repeats
cmd="python ablation.py \
    --start ${n} \
    --end $((n+1)) \
    --step 1 \
    --repeat 1 \
    --environment ${env} \
    --random_seed ${seed} \
    --comment \"${comment}\""

# Conditionally add arguments if they are not "None"
if [ "${algo}" != "" ] && [ "${algo}" != "None" ]; then
    cmd="${cmd} --algorithm ${algo}"
fi

if [ "${sym_action}" != "None" ]; then
    cmd="${cmd} --symmetric_action ${sym_action}"
fi

if [ "${max_sym_level}" != "None" ]; then
    cmd="${cmd} --max_symmetry_level ${max_sym_level}"
fi

if [ "${save_opt}" == "True" ]; then
    cmd="${cmd} --save_optimal_terminal_state True"
fi

echo "Running command:"
echo "$cmd"
eval $cmd